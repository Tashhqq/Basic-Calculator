import sys
import os
import importlib
import traceback
from pathlib import Path
from PyQt5.QtCore import Qt, QPoint
from PyQt5.QtGui import QFontDatabase, QFont, QColor

# index.py
# Interfaz moderna y minimalista que usa la calculadora de basiccalculator.py
# Requisitos: PyQt5 (pip install PyQt5). Opcional: requests si desea descargar la fuente automáticamente.


from PyQt5.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel,
    QGridLayout, QSizePolicy, QFrame, QTextEdit
)

# Intentamos importar la calculadora del archivo basiccalculator.py en el mismo directorio.
# El adaptador tratará de llamar a funciones/atributos comunes: calculate, evaluate, eval, BasicCalculator.evaluate
calc_module = None
try:
    spec = importlib.import_module("basiccalculator")
    calc_module = spec
except Exception:
    # Si falla la importación, calc_module queda None y mostraremos error al intentar evaluar.
    calc_module = None

def evaluate_expression(expr: str) -> str:
    """Intenta evaluar usando basiccalculator.* con varios nombres comunes."""
    if not calc_module:
        return "Error: basiccalculator.py no importado"
    try:
        # elimina espacios redundantes
        expr_str = str(expr).strip()
        for name in ("calculate", "evaluate", "eval", "compute"):
            if hasattr(calc_module, name):
                fn = getattr(calc_module, name)
                try:
                    return str(fn(expr_str))
                except TypeError:
                    # quizá requiere diferente llamada; continue para otros intentos
                    pass
        # Si hay una clase BasicCalculator con método evaluate/calculate
        if hasattr(calc_module, "BasicCalculator"):
            cls = getattr(calc_module, "BasicCalculator")
            try:
                inst = cls()
                for name in ("evaluate", "calculate", "eval", "compute"):
                    if hasattr(inst, name):
                        return str(getattr(inst, name)(expr_str))
            except Exception:
                pass
        # último recurso: si el módulo expone '__call__'
        if callable(calc_module):
            return str(calc_module(expr_str))
        return "Error: función de evaluación no encontrada en basiccalculator.py"
    except Exception as e:
        return "Exception: " + str(e)

# Cargar fuente (opcional). Intentaremos cargar 'Inter' desde un archivo local o descargar si hay requests.
def load_modern_font():
    # lista de ubicaciones/recursos locales donde podría existir Inter/una fuente similar
    candidate_names = ["Inter", "SF Pro Text", "Segoe UI", "Helvetica Neue", "Arial"]
    # Intentamos cargar una fuente embebida si existe en carpeta 'fonts'
    font_dir = Path(__file__).parent / "fonts"
    if font_dir.exists():
        for f in font_dir.glob("*.ttf"):
            QFontDatabase.addApplicationFont(str(f))
    # No forzamos descarga aquí para mantener dependencia mínima.
    # Dejar que el sistema use el mejor disponible; devolver nombre preferido.
    for name in candidate_names:
        if QFont(name).family() != "":
            return name
    return QApplication.font().family()

class FramelessWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.Window)
        # Permitir fondos transparentes para efecto de bordes redondeados
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.m_pos = None
        self.setup_ui()

    def setup_ui(self):
        # Cargar fuente moderna
        font_name = load_modern_font()
        base_font = QFont(font_name, 11)
        self.setFont(base_font)

        # Main container con fondo blur-like (semi-opaque)
        container = QFrame()
        container.setObjectName("container")
        container.setStyleSheet("""
        #container {
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(255,255,255,230),
                        stop:1 rgba(245,245,245,220));
            border-radius: 14px;
        }
        """)
        main_layout = QVBoxLayout(container)
        main_layout.setContentsMargins(14, 14, 14, 14)
        main_layout.setSpacing(10)

        # Custom title bar
        title_bar = QHBoxLayout()
        title_bar.setContentsMargins(0, 0, 0, 0)
        title_label = QLabel("Calculadora • Modern UI")
        title_label.setStyleSheet("color: #111; font-weight: 600;")
        title_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Preferred)

        btn_min = QPushButton("—")
        btn_min.setFixedSize(36, 28)
        btn_min.setObjectName("btn")
        btn_close = QPushButton("✕")
        btn_close.setFixedSize(36, 28)
        btn_close.setObjectName("btn_close")

        btn_min.clicked.connect(self.showMinimized)
        btn_close.clicked.connect(self.close)

        title_bar.addWidget(title_label)
        title_bar.addWidget(btn_min)
        title_bar.addWidget(btn_close)
        main_layout.addLayout(title_bar)

        # Display (read-only) con estilo moderno
        self.display = QLabel("0")
        self.display.setObjectName("display")
        self.display.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
        self.display.setFixedHeight(70)
        self.display.setStyleSheet("""
        #display {
            background: transparent;
            color: #071020;
            font-size: 32px;
            font-weight: 600;
            padding-right: 14px;
        }
        """)
        main_layout.addWidget(self.display)

        # Grid de botones minimalistas y redondeados
        btn_styles = """
        QPushButton {
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(255,255,255,255),
                        stop:1 rgba(245,245,245,255));
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            color: #0b1220;
        }
        QPushButton:pressed {
            background: rgba(200,200,200,0.8);
        }
        QPushButton#accent {
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(0,122,255,255),
                        stop:1 rgba(10,132,255,255));
            color: white;
        }
        QPushButton#operator {
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(240,240,240,255),
                        stop:1 rgba(230,230,230,255));
            color: #111;
        }
        QPushButton#btn_close {
            background: transparent;
            color: #ba1a1a;
            font-weight: 700;
        }
        QPushButton#btn {
            background: transparent;
            color: #333;
        }
        """

        grid = QGridLayout()
        grid.setSpacing(10)

        buttons = [
            ('C', 0, 0), ('⌫', 0, 1), ('%', 0, 2), ('/', 0, 3),
            ('7', 1, 0), ('8', 1, 1), ('9', 1, 2), ('*', 1, 3),
            ('4', 2, 0), ('5', 2, 1), ('6', 2, 2), ('-', 2, 3),
            ('1', 3, 0), ('2', 3, 1), ('3', 3, 2), ('+', 3, 3),
            ('±', 4, 0), ('0', 4, 1), ('.', 4, 2), ('=', 4, 3),
        ]

        self.btn_map = {}
        for text, r, c in buttons:
            b = QPushButton(text)
            b.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)
            b.setMinimumHeight(56)
            if text in ('=',):
                b.setObjectName("accent")
            elif text in ('/', '*', '-', '+', '%'):
                b.setObjectName("operator")
            self.btn_map[text] = b
            grid.addWidget(b, r, c)

        main_layout.addLayout(grid)
        # Footer small credits
        footer = QLabel("Diseño moderno • Minimal • Usa basiccalculator.py")
        footer.setStyleSheet("color: #6b7280; font-size: 10px;")
        main_layout.addWidget(footer, alignment=Qt.AlignRight)

        # Apply overall stylesheet (container styles + buttons)
        full_style = """
        QWidget {
            font-family: "%s";
        }
        %s
        """ % (QApplication.font().family(), btn_styles)
        container.setStyleSheet(container.styleSheet() + "\n" + btn_styles)

        # Layout wrapper
        wrapper = QVBoxLayout(self)
        wrapper.setContentsMargins(10, 10, 10, 10)
        wrapper.addWidget(container)

        # Conexiones botones
        for k, btn in self.btn_map.items():
            if k == 'C':
                btn.clicked.connect(self.clear_display)
            elif k == '⌫':
                btn.clicked.connect(self.backspace)
            elif k == '=':
                btn.clicked.connect(self.calculate_result)
            elif k == '±':
                btn.clicked.connect(self.toggle_sign)
            else:
                btn.clicked.connect(lambda checked, t=k: self.push_token(t))

        # Tamaño inicial y sombra
        self.resize(420, 560)
        self.setStyleSheet("background: transparent;")

    # Comportamiento del display y botones
    def push_token(self, token):
        cur = self.display.text()
        if cur == "0" and token not in ('.',):
            cur = ""
        new = cur + token
        self.display.setText(new)

    def clear_display(self):
        self.display.setText("0")

    def backspace(self):
        cur = self.display.text()
        if len(cur) <= 1:
            self.display.setText("0")
        else:
            self.display.setText(cur[:-1])

    def toggle_sign(self):
        cur = self.display.text()
        if cur.startswith("-"):
            self.display.setText(cur[1:])
        else:
            if cur != "0":
                self.display.setText("-" + cur)

    def calculate_result(self):
        expr = self.display.text()
        # reemplazamos multiplicación y división visual por símbolos de cálculo
        expr = expr.replace('×', '*').replace('÷', '/')
        result = evaluate_expression(expr)
        self.display.setText(result)

    # Permitir arrastrar la ventana desde cualquier lugar del widget (o mejorar selectivamente)
    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton:
            self.m_pos = event.globalPos() - self.frameGeometry().topLeft()

    def mouseMoveEvent(self, event):
        if self.m_pos and event.buttons() & Qt.LeftButton:
            self.move(event.globalPos() - self.m_pos)

    def mouseReleaseEvent(self, event):
        self.m_pos = None

if __name__ == "__main__":
    app = QApplication(sys.argv)
    # Altos DPI
    QApplication.setAttribute(Qt.AA_EnableHighDpiScaling)
    QApplication.setAttribute(Qt.AA_UseHighDpiPixmaps)

    win = FramelessWindow()
    win.show()
    sys.exit(app.exec_())